<!-- Agent Control Panel - Phase 8: Agent Lifecycle Management -->
<!-- Optimized Version: Production-Ready UX with Robust Error Handling -->

<div class="agent-control-section" style="margin-bottom: 2rem;">
    <div class="neural-card">
        <div class="card-header">
            <h3 class="card-title">ü§ñ Agent Lifecycle Control</h3>
            <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">Start, stop, and manage agent processes</p>
        </div>

        <!-- Agent Control Grid -->
        <div id="agent-controls-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding: 1.5rem 0 0 0;">
            <!-- Individual agent cards will be rendered here -->
        </div>
    </div>
</div>

<script>
// Agent Control System - Optimized Version
class AgentControlSystem {
    constructor() {
        this.agents = [];
        this.operationInProgress = new Set();
        this.updateInterval = null;
        this.init();
    }

    async init() {
        console.log('ü§ñ Initializing Agent Control System...');
        try {
            await this.loadAgents();
            this.startAutoUpdate();
        } catch (error) {
            console.error('Initialization failed:', error);
            this.showLoadError();
        }
    }

    async loadAgents() {
        try {
            const response = await fetch('/dashboard/api/agents/status', {
                signal: AbortSignal.timeout(5000)
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            if (data.status === 'success' && Array.isArray(data.data?.agents)) {
                this.agents = data.data.agents;
                this.render();
                return true;
            } else {
                throw new Error('Invalid API response format');
            }
        } catch (error) {
            console.error('Failed to load agents:', error);
            throw error;
        }
    }

    render() {
        const grid = document.getElementById('agent-controls-grid');
        if (!grid) return;

        if (this.agents.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; padding: 2rem; text-align: center; color: var(--text-secondary);">No agents found</div>';
            return;
        }

        grid.innerHTML = this.agents.map((agent, idx) => this.createAgentCard(agent, idx)).join('');
        this.attachEventListeners();
    }

    createAgentCard(agent, index) {
        const agentId = agent.agent_id || 'unknown';
        const isRunning = agent.status === 'running';
        const statusColor = isRunning ? 'var(--neural-primary)' : '#666';
        const statusText = isRunning ? '‚óè Running' : '‚óè Stopped';

        return `
<div class="agent-card-item" data-agent-id="${agentId}" style="background: var(--gradient-neural); padding: 1.25rem; border-radius: 10px; border: 1px solid rgba(0, 255, 136, 0.3); animation: slide-in-up 0.4s ease-out; animation-delay: ${index * 50}ms;">
    <!-- Header -->
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${statusColor}; box-shadow: 0 0 8px ${statusColor};"></div>
        <div style="flex: 1;">
            <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-primary);">${agent.name || agentId}</h4>
            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">${agentId}</p>
        </div>
    </div>

    <!-- Status Info -->
    <div style="font-size: 0.85rem; margin-bottom: 1rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
                <div style="color: var(--text-muted); font-size: 0.75rem;">CPU</div>
                <div style="color: var(--text-primary); font-weight: 500;">${isRunning ? (agent.cpu_percent?.toFixed(1) || '-') + '%' : '-'}</div>
            </div>
            <div>
                <div style="color: var(--text-muted); font-size: 0.75rem;">Memory</div>
                <div style="color: var(--text-primary); font-weight: 500;">${isRunning ? (agent.memory_mb?.toFixed(1) || '-') + 'MB' : '-'}</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div>
                <div style="color: var(--text-muted); font-size: 0.75rem;">PID</div>
                <div style="color: var(--text-primary); font-family: monospace; font-size: 0.8rem;">${agent.pid || '-'}</div>
            </div>
            <div>
                <div style="color: var(--text-muted); font-size: 0.75rem;">Status</div>
                <div style="color: ${statusColor}; font-weight: 500;">${statusText}</div>
            </div>
        </div>
    </div>

    <!-- Control Buttons -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <button class="agent-btn-start" data-agent-id="${agentId}" style="padding: 0.5rem; font-size: 0.8rem; background: linear-gradient(135deg, var(--neural-primary), var(--neural-secondary)); color: var(--bg-primary); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; ${isRunning ? 'opacity: 0.5; cursor: not-allowed;' : 'hover:box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);'}" ${isRunning ? 'disabled' : ''}>
            ‚ñ∂Ô∏è Start
        </button>
        <button class="agent-btn-stop" data-agent-id="${agentId}" style="padding: 0.5rem; font-size: 0.8rem; background: rgba(255, 107, 53, 0.2); color: #FF6B35; border: 1px solid #FF6B35; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; ${!isRunning ? 'opacity: 0.5; cursor: not-allowed;' : 'hover:background: rgba(255, 107, 53, 0.3);'}" ${!isRunning ? 'disabled' : ''}>
            ‚èπÔ∏è Stop
        </button>
    </div>

    <!-- Status Message (Hidden by default) -->
    <div class="agent-status-msg" style="margin-top: 0.75rem; padding: 0.5rem; border-radius: 4px; font-size: 0.75rem; display: none; text-align: center;"></div>
</div>
        `;
    }

    attachEventListeners() {
        document.querySelectorAll('.agent-btn-start').forEach(btn => {
            btn.addEventListener('click', (e) => this.handleStart(e));
        });

        document.querySelectorAll('.agent-btn-stop').forEach(btn => {
            btn.addEventListener('click', (e) => this.handleStop(e));
        });
    }

    async handleStart(event) {
        const btn = event.target;
        const agentId = btn.dataset.agentId;
        
        if (this.operationInProgress.has(agentId)) {
            this.showMessage(agentId, 'Operation in progress...', 'warning');
            return;
        }

        this.operationInProgress.add(agentId);
        btn.disabled = true;
        btn.textContent = '‚è≥ Starting...';

        try {
            const response = await fetch(`/dashboard/api/agents/${agentId}/start`, {
                method: 'POST',
                signal: AbortSignal.timeout(30000)
            });

            const data = await response.json();
            
            if (data.status === 'started' || data.status === 'already_running') {
                this.showMessage(agentId, '‚úÖ Agent started', 'success');
                setTimeout(() => this.loadAgents(), 1500);
            } else {
                this.showMessage(agentId, `‚ùå Start failed: ${data.message || 'unknown error'}`, 'error');
            }
        } catch (error) {
            this.showMessage(agentId, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            btn.textContent = '‚ñ∂Ô∏è Start';
            btn.disabled = false;
            this.operationInProgress.delete(agentId);
        }
    }

    async handleStop(event) {
        const btn = event.target;
        const agentId = btn.dataset.agentId;
        
        if (this.operationInProgress.has(agentId)) {
            this.showMessage(agentId, 'Operation in progress...', 'warning');
            return;
        }

        this.operationInProgress.add(agentId);
        btn.disabled = true;
        btn.textContent = '‚è≥ Stopping...';

        try {
            const response = await fetch(`/dashboard/api/agents/${agentId}/stop`, {
                method: 'POST',
                signal: AbortSignal.timeout(15000)
            });

            const data = await response.json();
            
            if (data.status === 'stopped' || data.status === 'force_killed' || data.status === 'not_running') {
                this.showMessage(agentId, '‚úÖ Agent stopped', 'success');
                setTimeout(() => this.loadAgents(), 1500);
            } else {
                this.showMessage(agentId, `‚ùå Stop failed: ${data.message || 'unknown error'}`, 'error');
            }
        } catch (error) {
            this.showMessage(agentId, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            btn.textContent = '‚èπÔ∏è Stop';
            btn.disabled = false;
            this.operationInProgress.delete(agentId);
        }
    }

    showMessage(agentId, message, type) {
        const card = document.querySelector(`[data-agent-id="${agentId}"]`);
        if (!card) return;

        const msgDiv = card.querySelector('.agent-status-msg');
        if (!msgDiv) return;

        msgDiv.textContent = message;
        msgDiv.style.background = type === 'success' ? 'rgba(0, 255, 136, 0.2)' : 
                                  type === 'error' ? 'rgba(255, 107, 53, 0.2)' : 
                                  'rgba(255, 217, 61, 0.2)';
        msgDiv.style.color = type === 'success' ? 'var(--neural-primary)' : 
                            type === 'error' ? '#FF6B35' : 
                            '#FFD93D';
        msgDiv.style.display = 'block';

        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 3000);
        }
    }

    showLoadError() {
        const grid = document.getElementById('agent-controls-grid');
        if (grid) {
            grid.innerHTML = `
<div style="grid-column: 1/-1; padding: 2rem; text-align: center; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color);">
    <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
    <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Failed to Load Agents</h3>
    <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">Unable to connect to agent service. Retrying...</p>
    <button onclick="location.reload()" class="neural-button" style="padding: 0.5rem 1.5rem; font-size: 0.9rem;">üîÑ Reload</button>
</div>
            `;
        }
    }

    startAutoUpdate() {
        this.updateInterval = setInterval(() => {
            this.loadAgents().catch(err => console.error('Auto-update failed:', err));
        }, 15000);
        console.log('‚úÖ Auto-update started');
    }

    stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('agent-controls-grid')) {
        window.agentControlSystem = new AgentControlSystem();
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (window.agentControlSystem) {
        window.agentControlSystem.stopAutoUpdate();
    }
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
    if (window.agentControlSystem) {
        if (document.hidden) {
            window.agentControlSystem.stopAutoUpdate();
        } else {
            window.agentControlSystem.startAutoUpdate();
        }
    }
});
</script>
