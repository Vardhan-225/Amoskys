{% extends "auth/base.html" %}

{% block title %}Email Verification{% endblock %}

{% block header_title %}Verifying Email{% endblock %}
{% block header_subtitle %}Please wait...{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loading-state" class="text-center">
    <div class="loader" style="margin: 2rem auto;">
        <svg width="60" height="60" viewBox="0 0 50 50">
            <circle cx="25" cy="25" r="20" fill="none" stroke="var(--neural-primary)" stroke-width="3" stroke-dasharray="80" stroke-linecap="round">
                <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/>
            </circle>
        </svg>
    </div>
    <p class="text-muted">Verifying your email address...</p>
</div>

<!-- Success State -->
<div id="success-state" style="display: none;" class="text-center">
    <div style="font-size: 4rem; margin-bottom: 1.5rem;">✓</div>
    <h3 style="color: var(--neural-primary); margin-bottom: 1rem;">Email Verified!</h3>
    <p class="text-muted" style="margin-bottom: 2rem;">
        Your email has been verified successfully. You can now sign in to your account.
    </p>
    <a href="/auth/login" class="btn btn-primary btn-block">Sign In</a>
</div>

<!-- Error State -->
<div id="error-state" style="display: none;" class="text-center">
    <div style="font-size: 4rem; margin-bottom: 1.5rem;">⚠️</div>
    <h3 style="color: var(--neural-danger); margin-bottom: 1rem;" id="error-title">Verification Failed</h3>
    <p class="text-muted" style="margin-bottom: 2rem;" id="error-description">
        This verification link is invalid or has expired.
    </p>
    <a href="/auth/login" class="btn btn-primary btn-block">Go to Login</a>
    <p class="text-muted mt-3" style="font-size: 0.9rem;">
        Need a new verification email? 
        <a href="/auth/signup" class="form-link">Sign up again</a>
    </p>
</div>

<!-- Already Verified State -->
<div id="already-verified-state" style="display: none;" class="text-center">
    <div style="font-size: 4rem; margin-bottom: 1.5rem;">ℹ️</div>
    <h3 style="color: var(--neural-secondary); margin-bottom: 1rem;">Already Verified</h3>
    <p class="text-muted" style="margin-bottom: 2rem;">
        Your email has already been verified. You can sign in to your account.
    </p>
    <a href="/auth/login" class="btn btn-primary btn-block">Sign In</a>
</div>
{% endblock %}

{% block footer %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const loadingState = document.getElementById('loading-state');
    const successState = document.getElementById('success-state');
    const errorState = document.getElementById('error-state');
    const alreadyVerifiedState = document.getElementById('already-verified-state');
    const errorTitle = document.getElementById('error-title');
    const errorDescription = document.getElementById('error-description');
    
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        showError('Verification Failed', 'No verification token provided.');
        return;
    }
    
    try {
        const response = await fetch('/api/user/auth/verify-email?token=' + encodeURIComponent(token), {
            method: 'GET',
            credentials: 'same-origin',
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            loadingState.style.display = 'none';
            successState.style.display = 'block';
        } else {
            switch (data.error_code) {
                case 'ALREADY_VERIFIED':
                    loadingState.style.display = 'none';
                    alreadyVerifiedState.style.display = 'block';
                    break;
                case 'INVALID_TOKEN':
                    showError('Invalid Link', 'This verification link is invalid or has expired.');
                    break;
                case 'USER_NOT_FOUND':
                    showError('Account Not Found', 'The associated account no longer exists.');
                    break;
                default:
                    showError('Verification Failed', data.error || 'An unexpected error occurred.');
            }
        }
    } catch (error) {
        console.error('Verification error:', error);
        showError('Network Error', 'Could not connect to the server. Please try again.');
    }
    
    function showError(title, description) {
        loadingState.style.display = 'none';
        errorTitle.textContent = title;
        errorDescription.textContent = description;
        errorState.style.display = 'block';
    }
});
</script>
{% endblock %}
