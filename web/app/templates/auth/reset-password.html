{% extends "auth/base.html" %}

{% block title %}Reset Password{% endblock %}

{% block header_title %}Create New Password{% endblock %}
{% block header_subtitle %}Enter your new password below{% endblock %}

{% block content %}
<form id="reset-password-form" method="POST" novalidate>
    <input type="hidden" id="token" name="token" value="{{ request.args.get('token', '') }}">
    
    <div class="form-group">
        <label for="password" class="form-label">New Password</label>
        <div class="input-wrapper">
            <input 
                type="password" 
                id="password" 
                name="password" 
                class="form-input" 
                placeholder="Create a strong password"
                autocomplete="new-password"
                required
            >
            <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" class="eye-open"/>
                    <circle cx="12" cy="12" r="3" class="eye-open"/>
                </svg>
            </button>
        </div>
        <p class="form-error" id="password-error">Password is required</p>
        
        <!-- Password strength indicator -->
        <div class="password-strength" id="password-strength" style="display: none;">
            <div class="strength-bar">
                <div class="strength-fill" id="strength-fill"></div>
            </div>
            <p class="strength-text" id="strength-text"></p>
        </div>
    </div>
    
    <div class="form-group">
        <label for="confirm_password" class="form-label">Confirm New Password</label>
        <div class="input-wrapper">
            <input 
                type="password" 
                id="confirm_password" 
                name="confirm_password" 
                class="form-input" 
                placeholder="Confirm your password"
                autocomplete="new-password"
                required
            >
        </div>
        <p class="form-error" id="confirm_password-error">Passwords do not match</p>
    </div>
    
    <!-- Password Requirements -->
    <div class="password-requirements" id="password-requirements">
        <h4>Password Requirements</h4>
        <ul>
            <li id="req-length">At least 12 characters</li>
            <li id="req-upper">One uppercase letter</li>
            <li id="req-lower">One lowercase letter</li>
            <li id="req-number">One number</li>
            <li id="req-special">One special character (!@#$%^&*...)</li>
        </ul>
    </div>
    
    <button type="submit" class="btn btn-primary btn-block mt-3" id="submit-btn">
        <span class="btn-text">Reset Password</span>
    </button>
</form>

<!-- Invalid Token State -->
<div id="invalid-token-state" style="display: none;">
    <div class="text-center">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <h3 style="color: var(--neural-danger); margin-bottom: 1rem;">Invalid or Expired Link</h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
            This password reset link is invalid or has expired.
        </p>
        <a href="/auth/forgot-password" class="btn btn-primary">Request New Reset Link</a>
    </div>
</div>

<!-- Success State -->
<div id="success-state" style="display: none;">
    <div class="text-center">
        <div style="font-size: 3rem; margin-bottom: 1rem;">✓</div>
        <h3 style="color: var(--neural-primary); margin-bottom: 1rem;">Password Reset Successful</h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
            Your password has been updated. You can now sign in with your new password.
        </p>
        <a href="/auth/login" class="btn btn-primary">Sign In</a>
    </div>
</div>
{% endblock %}

{% block footer %}
<p class="text-muted">
    Remember your password? 
    <a href="/auth/login" class="form-link">Sign in</a>
</p>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reset-password-form');
    const tokenInput = document.getElementById('token');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submit-btn');
    const invalidTokenState = document.getElementById('invalid-token-state');
    const successState = document.getElementById('success-state');
    
    // Check if token is present
    if (!tokenInput.value) {
        form.style.display = 'none';
        document.querySelector('.auth-card-footer').style.display = 'none';
        invalidTokenState.style.display = 'block';
        return;
    }
    
    // Password visibility toggle
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.previousElementSibling;
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
        });
    });
    
    // Password strength checker
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');
        const strengthFill = document.getElementById('strength-fill');
        const strengthText = document.getElementById('strength-text');
        
        if (password.length === 0) {
            strengthDiv.style.display = 'none';
            return;
        }
        
        strengthDiv.style.display = 'block';
        
        const requirements = {
            length: password.length >= 12,
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password),
        };
        
        Object.keys(requirements).forEach(req => {
            const el = document.getElementById('req-' + req);
            if (el) el.classList.toggle('valid', requirements[req]);
        });
        
        const score = Object.values(requirements).filter(Boolean).length;
        
        strengthFill.className = 'strength-fill';
        if (score <= 1) {
            strengthFill.classList.add('weak');
            strengthText.textContent = 'Weak password';
        } else if (score <= 2) {
            strengthFill.classList.add('fair');
            strengthText.textContent = 'Fair password';
        } else if (score <= 4) {
            strengthFill.classList.add('good');
            strengthText.textContent = 'Good password';
        } else {
            strengthFill.classList.add('strong');
            strengthText.textContent = 'Strong password';
        }
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        hideError();
        clearFieldErrors();
        
        let isValid = true;
        
        if (!passwordInput.value || passwordInput.value.length < 12) {
            showFieldError('password', 'Password must be at least 12 characters');
            isValid = false;
        }
        
        if (passwordInput.value !== confirmPasswordInput.value) {
            showFieldError('confirm_password', 'Passwords do not match');
            isValid = false;
        }
        
        if (!isValid) return;
        
        setLoading(true);
        
        try {
            const response = await fetch('/api/user/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: tokenInput.value,
                    new_password: passwordInput.value,
                }),
                credentials: 'same-origin',
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                form.style.display = 'none';
                document.querySelector('.auth-card-footer').style.display = 'none';
                document.getElementById('password-requirements').style.display = 'none';
                successState.style.display = 'block';
            } else {
                if (data.error_code === 'INVALID_TOKEN') {
                    form.style.display = 'none';
                    document.querySelector('.auth-card-footer').style.display = 'none';
                    invalidTokenState.style.display = 'block';
                } else if (data.error_code === 'INVALID_PASSWORD') {
                    showFieldError('password', data.error);
                } else {
                    showError(data.error || 'An error occurred. Please try again.');
                }
            }
        } catch (error) {
            console.error('Reset password error:', error);
            showError('Network error. Please check your connection and try again.');
        } finally {
            setLoading(false);
        }
    });
    
    // Helper functions
    function showFieldError(field, message) {
        const input = document.getElementById(field);
        const group = input.closest('.form-group');
        const errorEl = document.getElementById(field + '-error');
        group.classList.add('has-error');
        input.classList.add('error');
        if (errorEl) errorEl.textContent = message;
    }
    
    function clearFieldErrors() {
        document.querySelectorAll('.form-group.has-error').forEach(el => el.classList.remove('has-error'));
        document.querySelectorAll('.form-input.error').forEach(el => el.classList.remove('error'));
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = message;
        errorDiv.style.display = 'flex';
    }
    
    function hideError() {
        document.getElementById('error-message').style.display = 'none';
    }
    
    function setLoading(loading) {
        submitBtn.classList.toggle('btn-loading', loading);
        submitBtn.disabled = loading;
    }
});
</script>
{% endblock %}
