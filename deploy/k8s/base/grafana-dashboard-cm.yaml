# AMOSKYS Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-amoskys-dashboard
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
    grafana_dashboard: "1"
data:
  amoskys-overview.json: |
    {
      "title": "AMOSKYS Overview",
      "uid": "amoskys-overview",
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "30s",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "type": "stat",
          "title": "Active Agents",
          "targets": [{"expr": "count(up{job=\"amoskys-agents\"} == 1)"}],
          "gridPos": {"x": 0, "y": 0, "w": 6, "h": 4}
        },
        {
          "id": 2,
          "type": "stat",
          "title": "Web Pods Running",
          "targets": [{"expr": "count(up{job=\"amoskys-web\"} == 1)"}],
          "gridPos": {"x": 6, "y": 0, "w": 6, "h": 4}
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Request Rate (/s)",
          "targets": [{"expr": "sum(rate(http_requests_total{job=\"amoskys-web\"}[5m]))"}],
          "gridPos": {"x": 12, "y": 0, "w": 6, "h": 4}
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Error Rate (%)",
          "targets": [{"expr": "100 * sum(rate(http_requests_total{job=\"amoskys-web\",status=~\"5..\"}[5m])) / sum(rate(http_requests_total{job=\"amoskys-web\"}[5m]))"}],
          "gridPos": {"x": 18, "y": 0, "w": 6, "h": 4}
        },
        {
          "id": 5,
          "type": "timeseries",
          "title": "Agent WAL Backlog (bytes)",
          "targets": [{"expr": "agent_wal_backlog_bytes"}],
          "gridPos": {"x": 0, "y": 4, "w": 12, "h": 7}
        },
        {
          "id": 6,
          "type": "timeseries",
          "title": "Agent Publish Latency (ms, p50/p95)",
          "targets": [
            {"expr": "histogram_quantile(0.5, sum(rate(agent_publish_latency_ms_bucket[5m])) by (le))", "legendFormat": "p50"},
            {"expr": "histogram_quantile(0.95, sum(rate(agent_publish_latency_ms_bucket[5m])) by (le))", "legendFormat": "p95"}
          ],
          "gridPos": {"x": 12, "y": 4, "w": 12, "h": 7}
        },
        {
          "id": 7,
          "type": "timeseries",
          "title": "Retry & Fail Rates (/s)",
          "targets": [
            {"expr": "rate(agent_publish_retry_total[1m])", "legendFormat": "retry/s"},
            {"expr": "rate(agent_publish_fail_total[1m])", "legendFormat": "fail/s"}
          ],
          "gridPos": {"x": 0, "y": 11, "w": 12, "h": 7}
        },
        {
          "id": 8,
          "type": "stat",
          "title": "Bus Invalid Total",
          "targets": [{"expr": "bus_invalid_total"}],
          "gridPos": {"x": 12, "y": 11, "w": 6, "h": 7}
        },
        {
          "id": 9,
          "type": "stat",
          "title": "Bus Publish Total",
          "targets": [{"expr": "bus_publish_total"}],
          "gridPos": {"x": 18, "y": 11, "w": 6, "h": 7}
        },
        {
          "id": 10,
          "type": "timeseries",
          "title": "Bus In-Flight Requests (queue depth)",
          "targets": [{"expr": "bus_inflight_requests"}],
          "gridPos": {"x": 0, "y": 18, "w": 12, "h": 7}
        },
        {
          "id": 11,
          "type": "stat",
          "title": "Bus RETRY Total",
          "targets": [{"expr": "bus_retry_total"}],
          "gridPos": {"x": 12, "y": 18, "w": 6, "h": 7}
        },
        {
          "id": 12,
          "type": "stat",
          "title": "Agent Publish p95 (ms, 5m)",
          "targets": [{"expr": "agent_publish_latency_ms:p95_5m"}],
          "gridPos": {"x": 18, "y": 18, "w": 6, "h": 7}
        },
        {
          "id": 13,
          "type": "timeseries",
          "title": "Web Pod CPU Usage",
          "targets": [{"expr": "rate(container_cpu_usage_seconds_total{pod=~\"amoskys-web.*\"}[5m]) * 100", "legendFormat": "{{pod}}"}],
          "gridPos": {"x": 0, "y": 25, "w": 12, "h": 7}
        },
        {
          "id": 14,
          "type": "timeseries",
          "title": "Web Pod Memory Usage (MB)",
          "targets": [{"expr": "container_memory_usage_bytes{pod=~\"amoskys-web.*\"} / 1024 / 1024", "legendFormat": "{{pod}}"}],
          "gridPos": {"x": 12, "y": 25, "w": 12, "h": 7}
        }
      ]
    }
