# AMOSKYS Production Environment Overlay
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: amoskys

labels:
  - pairs:
      environment: production
    includeSelectors: false

resources:
  - ../../base
  - network-policy.yaml
  - pod-security-policy.yaml

patches:
  # Add Pod Security Admission labels to namespace
  - patch: |-
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1enforce
        value: restricted
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1enforce-version
        value: latest
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1warn
        value: restricted
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1warn-version
        value: latest
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1audit
        value: restricted
      - op: add
        path: /metadata/labels/pod-security.kubernetes.io~1audit-version
        value: latest
    target:
      kind: Namespace
      name: amoskys

  # Production replicas - high availability
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
    target:
      kind: Deployment
      name: amoskys-web
  
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 5
    target:
      kind: Deployment
      name: amoskys-agent

  # Production resource limits - higher capacity
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 250m
    target:
      kind: Deployment
      name: amoskys-web

  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
    target:
      kind: Deployment
      name: amoskys-agent
  
  # Production HPA - scale aggressively
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 20
    target:
      kind: HorizontalPodAutoscaler
      name: amoskys-web-hpa
  
  - patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 5
      - op: replace
        path: /spec/maxReplicas
        value: 50
    target:
      kind: HorizontalPodAutoscaler
      name: amoskys-agent-hpa

  # Production PDB - ensure availability
  - patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 2
    target:
      kind: PodDisruptionBudget
      name: amoskys-web-pdb

  - patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 3
    target:
      kind: PodDisruptionBudget
      name: amoskys-agent-pdb

  # Production storage - larger volumes
  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 50Gi
    target:
      kind: PersistentVolumeClaim
      name: prometheus-data
  
  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 10Gi
    target:
      kind: PersistentVolumeClaim
      name: grafana-data

  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 50Gi
    target:
      kind: PersistentVolumeClaim
      name: amoskys-data

  # Production Prometheus - higher retention and resources
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 4Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 2000m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 2Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
    target:
      kind: Deployment
      name: prometheus

  # Use required pod anti-affinity in production
  - patch: |-
      - op: replace
        path: /spec/template/spec/affinity/podAntiAffinity
        value:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - amoskys-web
              topologyKey: kubernetes.io/hostname
    target:
      kind: Deployment
      name: amoskys-web

configMapGenerator:
  - name: amoskys-config
    behavior: merge
    literals:
      - FLASK_DEBUG=false
      - LOG_LEVEL=WARNING
      - FORCE_HTTPS=true
      - FLASK_ENV=production
      - JSON_LOGS=true
      - AMOSKYS_REQUIRE_EMAIL_VERIFICATION=true
      - SESSION_COOKIE_SECURE=true

# NOTE: In production, use sealed-secrets or external-secrets operator
# These are placeholders - MUST be replaced before deployment
secretGenerator:
  - name: amoskys-secrets
    behavior: merge
    literals:
      - SECRET_KEY=REPLACE_WITH_SEALED_SECRET
      - AGENT_SECRET=REPLACE_WITH_SEALED_SECRET
      - EMAIL_PASSWORD=REPLACE_WITH_SEALED_SECRET

  - name: grafana-secrets
    behavior: merge
    literals:
      - admin-user=admin
      - admin-password=REPLACE_WITH_SEALED_SECRET

images:
  - name: ghcr.io/vardhan-225/amoskys-web
    newTag: v1.0.0
  - name: ghcr.io/vardhan-225/amoskys-agent
    newTag: v1.0.0
